<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Xtrackup数据库备份</title>
      <link href="/posts/d89579c7.html"/>
      <url>/posts/d89579c7.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用开源工具xtrackup备份数据"><a href="#使用开源工具xtrackup备份数据" class="headerlink" title="使用开源工具xtrackup备份数据"></a>使用开源工具xtrackup备份数据</h1><p>工具下载</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://www.percona.com/downloads</span></span><br><span class="line"></span><br><span class="line">wget https://downloads.percona.com/downloads/Percona-XtraBackup-8.0/Percona-XtraBackup-8.0.28-21/binary/redhat/7/x86_64/percona-xtrabackup-80-8.0.28-21.1.el7.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://downloads.percona.com/downloads/Percona-XtraBackup-8.0/Percona-XtraBackup-8.0.31-24/binary/redhat/7/x86_64/percona-xtrabackup-80-8.0.31-24.1.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">yum -y localinstall percona-xtrabackup-80-8.0.28-21.1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">create user &#x27;bkuser&#x27;@&#x27;localhost&#x27; identified by &#x27;password&#x27;;</span><br><span class="line"></span><br><span class="line">grant BACKUP_ADMIN,PROCESS,RELOAD,LOCK TABLES,REPLICATION CLIENT on *.* to &#x27;bkuser&#x27;@&#x27;localhost&#x27;;</span><br><span class="line"></span><br><span class="line">grant SELECT ON performance_schema.log_status TO &#x27;bkuser&#x27;@&#x27;localhost&#x27;;</span><br><span class="line"></span><br><span class="line">grant SELECT ON performance_schema.keyring_component_status TO &#x27;bkuser&#x27;@&#x27;localhost&#x27;;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此脚本只适用于mysql8版本</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">crontab 设置：每月全备，每天增量</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">0 0 * * * backup_func.sh full 全备</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">0 2-22/2 * * * backup_func.sh incr 增备</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基础目录</span></span><br><span class="line">BACKUPDIR=/data/xtrabackup/mysql</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">全量备份目录</span></span><br><span class="line">Full=$BACKUPDIR/mysql/full</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">增量备份目录</span></span><br><span class="line">Incr=$BACKUPDIR/mysql/incr</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份归档目录</span></span><br><span class="line">Old=$BACKUPDIR/old</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志目录</span></span><br><span class="line">backLog=$BACKUPDIR/backup.log</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日期信息 用于全量备份归档</span></span><br><span class="line">MON=$(date +%Y%m)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mysql实例相关信息</span></span><br><span class="line">MYSQL=/usr/bin/mysql</span><br><span class="line">MYSQLADMIN=/usr/bin/mysqladmin</span><br><span class="line">DB_HOST=&#x27;localhost&#x27; #填写localhost 会尝试使用socket连接</span><br><span class="line">DB_PORT=3306</span><br><span class="line">DB_USER=&#x27;bkuser&#x27;</span><br><span class="line">DB_PASS=&#x27;password&#x27;</span><br><span class="line">DB_SOCK=/var/lib/mysql/mysql.sock</span><br><span class="line">DB_CONF=/etc/my.cnf</span><br><span class="line">qpress=$(which qpress)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份工具检查 必备 压缩备份需要qpress</span></span><br><span class="line">tools=&quot;percona-xtrabackup-80 qpress&quot;</span><br><span class="line"></span><br><span class="line">for i in $tools; do</span><br><span class="line">    if ! [[ $(rpm -qa $i) =~ $&#123;i&#125; ]]; then</span><br><span class="line">        echo -e &quot; Needed package $i not found.\n Pre check failed !!!&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mysql 运行状态监测</span></span><br><span class="line">if [ -z &quot;$($MYSQLADMIN --host=$DB_HOST --socket=$&#123;DB_SOCK&#125; --user=$DB_USER --password=$DB_PASS --port=$DB_PORT status | grep &#x27;Uptime&#x27;)&quot; ]; then</span><br><span class="line">    echo -e &quot;HALTED: MySQL does not appear to be running or incorrect username and password&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份用户名密码监测 <span class="comment"># 好像有点多余...</span></span></span><br><span class="line">if ! $(echo &#x27;exit&#x27; | $MYSQL -s --host=$DB_HOST --socket=$&#123;DB_SOCK&#125; --user=$DB_USER --password=$DB_PASS --port=$DB_PORT); then</span><br><span class="line">    echo -e &quot;HALTED: Supplied mysql username or password appears to be incorrect (not copied here for security, see script).&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除3天前的增量备份及一个月前的全量备份</span></span><br><span class="line">function delete_old()&#123;</span><br><span class="line">    echo &#x27;================================&#x27;</span><br><span class="line">    echo &#x27;删除3天前的增量备份文件夹&#x27;</span><br><span class="line">    #删除3天前的增量备份</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   <span class="built_in">cd</span> <span class="variable">$Incr</span>/ &amp;&amp; find ./ -maxdepth 1 -<span class="built_in">type</span> d -ctime +2 -regex <span class="string">&#x27;./[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> -rf &#123;&#125; \;</span></span><br><span class="line">    echo &#x27;删除2月前的全量备份文件夹&#x27;</span><br><span class="line">    #删除2月前的全量备份</span><br><span class="line">    cd $Full/ &amp;&amp; find ./ -maxdepth 1 -type d -ctime +60 -regex &#x27;./[0-9][0-9][0-9][0-9][0-9][0-9]&#x27; -exec rm -rf &#123;&#125; \;</span><br><span class="line">    #</span><br><span class="line">    echo &#x27;删除2月前的备份压缩文件&#x27;</span><br><span class="line">    cd $Old/ &amp;&amp; find ./ -maxdepth 1 -type f -ctime +60 -regex &#x27;./[0-9][0-9][0-9][0-9][0-9][0-9].tar.gz&#x27; -exec rm -rf &#123;&#125; \;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">归档备份函数(全量时自动触发) 全量每月一次</span></span><br><span class="line">function Xtr_tar_backup() &#123;</span><br><span class="line">    # if [ ! -d &quot;$&#123;Old&#125;&quot; ]; then</span><br><span class="line">    #     mkdir $&#123;Old&#125;</span><br><span class="line">    # fi</span><br><span class="line">    for i in $Full $Incr $Old; do</span><br><span class="line">        if [ ! -d $i ]; then</span><br><span class="line">            mkdir -pv $i</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">    # 压缩上传前一天的备份</span><br><span class="line">    echo &quot;压缩前一天的备份，移动到$&#123;Old&#125;&quot;</span><br><span class="line">    cd $BACKUPDIR</span><br><span class="line">    tar -zcvf $MON.tar.gz ./full/ ./incr/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">归档后数据清除</span></span><br><span class="line">    #scp -P 8022 $YESTERDAY.tar.gz root@192.168.10.46:/data/backup/mysql/</span><br><span class="line">    mv $MON.tar.gz $Old</span><br><span class="line">    if [ $? = 0 ]; then</span><br><span class="line">        rm -rf $Full $Incr</span><br><span class="line">        echo &quot;Tar old backup succeed&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    else</span><br><span class="line">        echo &quot;Error with old backup.&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">全量备份函数(手动触发)</span></span><br><span class="line">function Xtr_full_backup() &#123;</span><br><span class="line">    if [ ! -d &quot;$&#123;Full&#125;&quot; ]; then</span><br><span class="line">        mkdir $&#123;Full&#125;</span><br><span class="line">    fi</span><br><span class="line">    Xtr_tar_backup</span><br><span class="line">    # 第一步 创建本次的备份目录</span><br><span class="line">    FullBakTime=$(date +%Y%m)</span><br><span class="line">    mkdir -p $&#123;Full&#125;/$&#123;FullBakTime&#125;</span><br><span class="line">    FullBakDir=$&#123;Full&#125;/$&#123;FullBakTime&#125;</span><br><span class="line">    # 第二步 开始全量备份</span><br><span class="line">    echo -e &quot;备份时间: $&#123;FullBakTime&#125;\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    echo -e &quot;本次全量备份目录为 $&#123;FullBakDir&#125;\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    xtrabackup --defaults-file=$&#123;DB_CONF&#125; --host=$&#123;DB_HOST&#125; --port=$DB_PORT --user=$&#123;DB_USER&#125; --password=$&#123;DB_PASS&#125; --socket=$&#123;DB_SOCK&#125; --backup --compress --compress-threads=4 --target-dir=$&#123;FullBakDir&#125;</span><br><span class="line">    dirStorage=$(du -sh $&#123;FullBakDir&#125;)</span><br><span class="line">    echo -e &quot;本次备份数据 $&#123;dirStorage&#125;\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    echo -e &quot;备份完成...\n\n\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    exit 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">增量备份函数(手动触发)</span></span><br><span class="line">function Xtr_incr_backup() &#123;</span><br><span class="line">    # 第一步 获取上一次全量备份和增量备份信息</span><br><span class="line">    LATEST_INCR=$(find $Incr -mindepth 1 -maxdepth 1 -type d | sort -nr | head -1)</span><br><span class="line">    LATEST_FULL=$(find $Full -mindepth 1 -maxdepth 1 -type d | sort -nr | head -1)</span><br><span class="line">    if [ ! $LATEST_FULL]; then</span><br><span class="line">        echo &quot;xtrabackup_info does not exist. Please make sure full backup exist.&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    echo &quot;LATEST_INCR=$LATEST_INCR&quot;</span><br><span class="line">    if [ ! -d &quot;$&#123;Incr&#125;&quot; ]; then</span><br><span class="line">        mkdir $&#123;Incr&#125;</span><br><span class="line">    fi</span><br><span class="line">    # 判断上一次的备份路径,如果增量备份路径为空,则使用全量备份路径为--incremental-basedir</span><br><span class="line">    if [ ! $LATEST_INCR ]; then</span><br><span class="line">        CompliteLatestFullDir=$LATEST_FULL</span><br><span class="line">    else</span><br><span class="line">        CompliteLatestFullDir=$LATEST_INCR</span><br><span class="line">    fi</span><br><span class="line">    # 第二步 创建备份目录</span><br><span class="line">    IncrBakTime=$(date +%Y%m%d)</span><br><span class="line">    mkdir -p $&#123;Incr&#125;/$&#123;IncrBakTime&#125;</span><br><span class="line">    IncrBakDir=$&#123;Incr&#125;/$&#123;IncrBakTime&#125;</span><br><span class="line">    # 第三步 开始增量备份</span><br><span class="line">    echo -e &quot;日期: $&#123;IncrBakTime&#125;\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    echo -e &quot;整点: $&#123;Hour&#125;\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    echo -e &quot;本次备份为基于上一次备份$&#123;CompliteLatestFullDir&#125;的增量备份\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    echo -e &quot;本次增量备份目录为: $&#123;IncrBakDir&#125;\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    xtrabackup --defaults-file=$&#123;DB_CONF&#125; --host=$&#123;DB_HOST&#125; --port=$DB_PORT --user=$&#123;DB_USER&#125; --password=$&#123;DB_PASS&#125; --socket=$&#123;DB_SOCK&#125; --backup --compress --compress-threads=4 --parallel=4 --target-dir=$&#123;IncrBakDir&#125; --incremental-basedir=$&#123;CompliteLatestFullDir&#125;</span><br><span class="line">    dirStorage=$(du -sh $&#123;IncrBakDir&#125;)</span><br><span class="line">    echo -e &quot;本次备份数据 $&#123;dirStorage&#125;\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    echo -e &quot;备份完成...\n\n\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    exit 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主体备份函数</span></span><br><span class="line">function printInfo() &#123;</span><br><span class="line">    echo &quot;Your choice is $1&quot;</span><br><span class="line">&#125;</span><br><span class="line">case $1 in</span><br><span class="line">&quot;full&quot;)</span><br><span class="line">    echo &quot;Your choice is $1&quot;</span><br><span class="line">    delete_old</span><br><span class="line">    Xtr_full_backup</span><br><span class="line">    ;;</span><br><span class="line">&quot;incr&quot;)</span><br><span class="line">    echo &quot;Your choice is $1&quot;</span><br><span class="line">    Xtr_incr_backup</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    echo -e &quot;No parameters specified!\nFor example:\n$0 full\n$0 incr&quot;</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># mysql restore</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据源文件路径</span></span><br><span class="line">MYSQL_DATA_DIR=/home/mysqldata</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据备份路径</span></span><br><span class="line">BASEDIR=/data/xtrabackup/mysql</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">全量数据备份路径</span></span><br><span class="line">Full=$BASEDIR/full</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">增量备份路径</span></span><br><span class="line">Incr=$BASEDIR/incr</span><br><span class="line"></span><br><span class="line">MON=$(date -d &quot;1 month ago&quot; +%Y%m)</span><br><span class="line">TODAY=$(date +%Y%m%d)</span><br><span class="line">qpress=$(which qpress)</span><br><span class="line">baklog=$BASEDIR/backup.log</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当前年月 202304</span></span><br><span class="line">mon=$(date +%Y%m)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当前日期 04-&gt; 4</span> </span><br><span class="line">day=$(date +%-d)</span><br><span class="line"></span><br><span class="line">function Xtr_restore()&#123;</span><br><span class="line">    decompress</span><br><span class="line">    prepare</span><br><span class="line">    rm -rf $MYSQL_DATA_DIR/*</span><br><span class="line">    xtrabackup --copy-back --target-dir=$Full/$MON/</span><br><span class="line">    chown -R mysql:mysql $MYSQL_DATA_DIR/*</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压缩</span></span><br><span class="line">function decompress()&#123;</span><br><span class="line">    cd $Full/$MON</span><br><span class="line">    for bf in `find . -iname &quot;*\.qp&quot;`; do $qpress -d $bf $(dirname $bf) &amp;&amp; rm $bf; done</span><br><span class="line">    for ((i=1;i&lt;=$&#123;day&#125;;i++))</span><br><span class="line">    do </span><br><span class="line">        if [ -d $basedir/$&#123;mon&#125;0$i ];then</span><br><span class="line">            echo &quot;文件夹$basedir/$&#123;mon&#125;0$i不存在&quot;</span><br><span class="line">            else</span><br><span class="line">            cd  $Incr/$&#123;mon&#125;0$i</span><br><span class="line">            for bf in `find . -iname &quot;*\.qp&quot;`; do $qpress -d $bf $(dirname $bf) &amp;&amp; rm $bf; done</span><br><span class="line">    fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">prepare main</span> </span><br><span class="line">function prepare()&#123;</span><br><span class="line">    echo</span><br><span class="line">    echo &#x27;==========================================&#x27;</span><br><span class="line">    echo &#x27;&gt;&gt;&gt; 全量备份数据准备 &#123;step 1&#125; &gt;&gt;&gt;&#x27;</span><br><span class="line">    echo &#x27;==========================================&#x27;</span><br><span class="line">    echo -e &quot;step 1| 恢复数据第一次准备\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    xtrabackup --prepare --apply-log-only --target-dir=$Full/$MON/ &gt;&gt; $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    echo &#x27;==========================================&#x27;</span><br><span class="line">    echo &quot;&gt;&gt;&gt;增量备份数据准备 &#123;step 2&#125;: &gt;&gt;&gt;&quot;</span><br><span class="line">    echo &#x27;==========================================&#x27;</span><br><span class="line">    echo -e &quot;step 2| 增量备份数据准备\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    for ((i=1;i&lt;=$&#123;day&#125;;i++))</span><br><span class="line">    do</span><br><span class="line">        if [ -d $basedir/$&#123;mon&#125;0$i ];then</span><br><span class="line">            echo &quot;文件夹$basedir/$&#123;mon&#125;0$i不存在&quot;</span><br><span class="line">            else</span><br><span class="line">            xtrabackup --prepare --apply-log-only --target-dir=$Full/$MON/ --incremental-dir=$Incr/$basedir/$&#123;mon&#125;0$i &gt;&gt; $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">            fi</span><br><span class="line">    done        </span><br><span class="line">    echo </span><br><span class="line">    echo &#x27;==========================================&#x27;</span><br><span class="line">    echo &#x27;&gt;&gt;&gt; Prepare&#x27;</span><br><span class="line">    echo &#x27;==========================================&#x27;</span><br><span class="line">    echo -e &quot;step 3| 完成准备\n&quot; | tee -a $&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">    xtrabackup --prepare --target-dir=$Full/$MON/ &gt;&gt;$&#123;baklog&#125; 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function printInfo() &#123;</span><br><span class="line">    echo &quot;Your choice is $1&quot;</span><br><span class="line">&#125;</span><br><span class="line">case $1 in</span><br><span class="line">&quot;restore&quot;)</span><br><span class="line">    echo &quot;Your choice is $1&quot;</span><br><span class="line">    Xtr_restore</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    echo -e &quot;No parameters specified!\nFor example:\n$0 restroe&quot;</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> 工具 </category>
          
          <category> 脚本 </category>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
